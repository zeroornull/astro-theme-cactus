---
import { type CollectionEntry, getCollection } from "astro:content";
import SocialList from "@/components/SocialList.astro";
// 保留：你导入的赞助商组件
import SponsorSection from "@/components/SponsorSection.astro";
import PostPreview from "@/components/blog/PostPreview.astro";
import Note from "@/components/note/Note.astro";
import { getAllPosts } from "@/data/post";
import PageLayout from "@/layouts/Base.astro";
import { collectionDateSort } from "@/utils/date";

// Posts Logic - 采用源仓库的逻辑以支持置顶文章
const MAX_POSTS = 10;
const allPosts = await getAllPosts();
const allPostsByDate = allPosts.sort(collectionDateSort) as CollectionEntry<"post">[];

// 新增：源仓库的置顶文章逻辑
const MAX_PINNED_POSTS = 3;
const pinnedPosts = allPostsByDate.filter((p) => p.data.pinned).slice(0, MAX_PINNED_POSTS);

// 定义最新文章列表
const latestPosts = allPostsByDate.slice(0, MAX_POSTS);

// Notes - 融合源仓库的类型定义优化
const MAX_NOTES = 5;
const allNotes = await getCollection("note");
const latestNotes = allNotes
  .sort(collectionDateSort)
  .slice(0, MAX_NOTES) as CollectionEntry<"note">[];
---

<PageLayout meta={{ title: "Home" }}>
  <div class="flex flex-col md:flex-row md:gap-8 lg:gap-12">

    {/* 左侧主内容区域 */}
    <main class="w-full md:w-2/3">
      <section>
        {/* 保留：你的双语问候 */}
        <h1 class="title mb-6">Hello World!</h1>
        <h1 class="title mb-6">你好呀！</h1>
        <p class="mb-4">
          Hi, Thanks for your comming.
        </p>
        <p class="mb-4">
          你好呀，感谢你来看我。
        </p>
        <SocialList />
      </section>

      {/* 新增：插入源仓库的置顶文章板块 */}
      {
        pinnedPosts.length > 0 && (
          <section class="mt-16">
            <h2 class="title mb-6 text-xl">Pinned Posts</h2>
            <ul class="space-y-4" role="list">
              {pinnedPosts.map((p) => (
                <li class="grid gap-1 sm:grid-cols-[auto_1fr]">
                  <PostPreview post={p} />
                </li>
              ))}
            </ul>
          </section>
        )
      }

      <section class="mt-16">
        <h2 class="title text-accent mb-6 text-xl"><a href="/posts/">Posts</a></h2>
        <ul class="space-y-4" role="list">
          {
            latestPosts.map((p) => (
              <li class="grid gap-2 sm:grid-cols-[auto_1fr]">
                <PostPreview post={p} />
              </li>
            ))
          }
        </ul>
      </section>

      {
        latestNotes.length > 0 && (
          <section class="mt-16">
            <h2 class="title text-accent mb-6 text-xl">
              <a href="/notes/">Notes</a>
            </h2>
            <ul class="space-y-4" role="list">
              {latestNotes.map((note) => (
                <li>
                  <Note note={note} as="h3" isPreview />
                </li>
              ))}
            </ul>
          </section>
        )
      }
    </main>

    {/* 右侧侧边栏区域 - 保留你的广告和赞助代码 */}
    <aside class="w-full md:w-1/3 mt-12 md:mt-0">

      <div class="mb-12">
        <SponsorSection />
        <iframe
          frameborder="0"
          src="https://support.nodeget.com/page/promotion?id=163"
          style="border-radius:4px; width: 105%; height: 315px; transform-origin: top left;"
        ></iframe>
      </div>

    </aside>

  </div>
</PageLayout>
